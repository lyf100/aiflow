{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://aiflow.dev/schemas/analysis-v1.0.0.json",
  "title": "AIFlow Analysis Data Protocol",
  "description": "标准化数据协议 v1.0.0 - AI 分析指挥与可视化平台的核心数据格式规范",
  "version": "1.0.0",
  "type": "object",
  "required": ["$schema", "version", "project_metadata", "code_structure", "execution_trace"],
  "properties": {
    "$schema": {
      "type": "string",
      "const": "https://aiflow.dev/schemas/analysis-v1.0.0.json",
      "description": "Schema 版本标识符"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "数据协议版本号（语义化版本）"
    },
    "project_metadata": {
      "type": "object",
      "required": ["project_name", "project_path", "language", "analyzed_at"],
      "properties": {
        "project_name": {
          "type": "string",
          "description": "项目名称"
        },
        "project_path": {
          "type": "string",
          "description": "项目路径"
        },
        "language": {
          "type": "string",
          "description": "主要编程语言"
        },
        "framework": {
          "type": "string",
          "description": "主要框架（可选）"
        },
        "architecture_pattern": {
          "type": "string",
          "description": "架构模式（可选）"
        },
        "analyzed_at": {
          "type": "string",
          "format": "date-time",
          "description": "分析时间（ISO 8601 格式）"
        },
        "ai_model": {
          "type": "string",
          "description": "使用的 AI 模型（可选）"
        },
        "total_lines": {
          "type": "integer",
          "minimum": 0,
          "description": "代码总行数（可选）"
        }
      }
    },
    "code_structure": {
      "type": "object",
      "required": ["nodes", "edges"],
      "properties": {
        "nodes": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/CodeNode"
          },
          "description": "代码节点列表（用于 Cytoscape.js 渲染）"
        },
        "edges": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/CodeEdge"
          },
          "description": "代码边列表（表示节点间的关系）"
        }
      }
    },
    "behavior_metadata": {
      "type": "object",
      "properties": {
        "launch_buttons": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/LaunchButton"
          },
          "description": "启动按钮列表"
        }
      }
    },
    "execution_trace": {
      "type": "object",
      "required": ["traceable_units"],
      "properties": {
        "traceable_units": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/TraceableUnit"
          },
          "description": "可执行单元列表"
        }
      }
    },
    "concurrency_info": {
      "type": "object",
      "properties": {
        "flows": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/ConcurrencyFlow"
          },
          "description": "并发流列表"
        },
        "sync_points": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/SyncPoint"
          },
          "description": "同步点列表"
        }
      }
    },
    "prompt_templates": {
      "type": "object",
      "properties": {
        "used_prompts": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id", "stage", "executed_at"],
            "properties": {
              "id": {
                "type": "string",
                "description": "Prompt 模板 ID"
              },
              "stage": {
                "type": "string",
                "enum": ["project_understanding", "structure_recognition", "semantic_analysis", "execution_inference", "concurrency_detection"],
                "description": "分析阶段"
              },
              "executed_at": {
                "type": "string",
                "format": "date-time",
                "description": "执行时间"
              }
            }
          },
          "description": "使用的 Prompt 模板记录"
        }
      }
    }
  },
  "definitions": {
    "CodeNode": {
      "type": "object",
      "required": ["id", "label", "stereotype"],
      "properties": {
        "id": {
          "type": "string",
          "description": "节点唯一 ID（UUID v4）"
        },
        "label": {
          "type": "string",
          "description": "AI 生成的业务语义化名称"
        },
        "parent": {
          "type": "string",
          "description": "父节点 ID（用于层级关系，可选）"
        },
        "classes": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Cytoscape.js 样式类"
        },
        "stereotype": {
          "type": "string",
          "enum": ["system", "module", "class", "function", "service", "component"],
          "description": "节点类型"
        },
        "metadata": {
          "type": "object",
          "properties": {
            "ai_confidence": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "AI 置信度分数（0.0-1.0）"
            },
            "ai_explanation": {
              "type": "string",
              "description": "AI 决策解释"
            },
            "code_location": {
              "type": "object",
              "properties": {
                "file_path": {
                  "type": "string"
                },
                "start_line": {
                  "type": "integer"
                },
                "end_line": {
                  "type": "integer"
                }
              }
            }
          }
        },
        "position": {
          "type": "object",
          "properties": {
            "x": {
              "type": "number"
            },
            "y": {
              "type": "number"
            }
          },
          "description": "节点位置（可选）"
        }
      }
    },
    "CodeEdge": {
      "type": "object",
      "required": ["id", "source", "target", "type"],
      "properties": {
        "id": {
          "type": "string",
          "description": "边唯一 ID"
        },
        "source": {
          "type": "string",
          "description": "源节点 ID"
        },
        "target": {
          "type": "string",
          "description": "目标节点 ID"
        },
        "type": {
          "type": "string",
          "enum": ["dependency", "inheritance", "composition", "call"],
          "description": "边类型"
        },
        "label": {
          "type": "string",
          "description": "边标签（可选）"
        }
      }
    },
    "LaunchButton": {
      "type": "object",
      "required": ["id", "node_id", "name", "type"],
      "properties": {
        "id": {
          "type": "string",
          "description": "按钮唯一 ID"
        },
        "node_id": {
          "type": "string",
          "description": "关联的节点 ID"
        },
        "name": {
          "type": "string",
          "description": "AI 生成的按钮名称（自然语言描述）"
        },
        "description": {
          "type": "string",
          "description": "按钮功能描述"
        },
        "type": {
          "type": "string",
          "enum": ["macro", "micro"],
          "description": "按钮类型（macro: 大按钮/宏观联动，micro: 小按钮/子流程）"
        },
        "icon": {
          "type": "string",
          "description": "图标（可选）"
        }
      }
    },
    "TraceableUnit": {
      "type": "object",
      "required": ["id", "name", "type", "traces"],
      "properties": {
        "id": {
          "type": "string",
          "description": "可执行单元唯一 ID"
        },
        "name": {
          "type": "string",
          "description": "AI 生成的功能名称"
        },
        "type": {
          "type": "string",
          "enum": ["single-trace", "multi-trace"],
          "description": "追踪类型（single-trace: 单线程，multi-trace: 多线程联动）"
        },
        "subUnitIds": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "子单元 ID 数组（定义行为父子关系，可选）"
        },
        "traces": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/Trace"
          },
          "description": "流程轨迹数组（支持多种格式）"
        }
      }
    },
    "Trace": {
      "type": "object",
      "required": ["format", "data"],
      "properties": {
        "format": {
          "type": "string",
          "enum": ["flowchart", "sequence", "step-by-step"],
          "description": "轨迹格式"
        },
        "data": {
          "oneOf": [
            {
              "$ref": "#/definitions/FlowchartTrace"
            },
            {
              "$ref": "#/definitions/SequenceTrace"
            },
            {
              "$ref": "#/definitions/StepByStepTrace"
            }
          ],
          "description": "轨迹数据（格式依赖于 format 字段）"
        }
      }
    },
    "FlowchartTrace": {
      "type": "object",
      "required": ["steps", "connections"],
      "properties": {
        "steps": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id", "label", "type"],
            "properties": {
              "id": {
                "type": "string"
              },
              "label": {
                "type": "string"
              },
              "type": {
                "type": "string",
                "enum": ["start", "end", "process", "decision", "fork", "join"],
                "description": "步骤类型（fork: 并发分叉，join: 并发汇合）"
              },
              "data": {
                "type": "object",
                "description": "步骤数据（可选）"
              }
            }
          },
          "description": "流程图步骤列表"
        },
        "connections": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id", "source", "target"],
            "properties": {
              "id": {
                "type": "string"
              },
              "source": {
                "type": "string",
                "description": "源步骤 ID"
              },
              "target": {
                "type": "string",
                "description": "目标步骤 ID"
              },
              "label": {
                "type": "string",
                "description": "连接标签（可选）"
              },
              "type": {
                "type": "string",
                "enum": ["control_flow", "data_flow"],
                "description": "连接类型"
              }
            }
          },
          "description": "流程图连接列表"
        }
      }
    },
    "SequenceTrace": {
      "type": "object",
      "required": ["lifelines", "messages"],
      "properties": {
        "lifelines": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id", "label", "type"],
            "properties": {
              "id": {
                "type": "string"
              },
              "label": {
                "type": "string",
                "description": "执行实体名称（线程、服务、组件）"
              },
              "type": {
                "type": "string",
                "description": "实体类型"
              }
            }
          },
          "description": "生命线列表"
        },
        "messages": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id", "source", "target", "type", "timestamp", "label"],
            "properties": {
              "id": {
                "type": "string"
              },
              "source": {
                "type": "string",
                "description": "源生命线 ID"
              },
              "target": {
                "type": "string",
                "description": "目标生命线 ID"
              },
              "type": {
                "type": "string",
                "enum": ["sync", "async", "return"],
                "description": "消息类型（sync: 同步，async: 异步，return: 返回）"
              },
              "timestamp": {
                "type": "number",
                "description": "时间戳"
              },
              "label": {
                "type": "string",
                "description": "消息标签"
              }
            }
          },
          "description": "消息列表"
        }
      }
    },
    "StepByStepTrace": {
      "type": "object",
      "required": ["steps", "variableScopes", "callStack"],
      "properties": {
        "steps": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id", "order", "file_path", "line_number", "code", "timestamp", "execution_order", "scope_id"],
            "properties": {
              "id": {
                "type": "string",
                "description": "步骤唯一标识符（UUID v4）"
              },
              "order": {
                "type": "integer",
                "minimum": 0,
                "description": "执行顺序（从0开始递增）"
              },
              "file_path": {
                "type": "string",
                "description": "代码文件路径"
              },
              "line_number": {
                "type": "integer",
                "minimum": 1,
                "description": "代码行号（从1开始）"
              },
              "code": {
                "type": "string",
                "description": "代码内容（单行）"
              },
              "timestamp": {
                "type": "string",
                "format": "date-time",
                "description": "执行时刻（ISO 8601 格式，如 2025-10-10T14:30:00.123Z）"
              },
              "execution_order": {
                "type": "integer",
                "minimum": 0,
                "description": "全局唯一执行序号（用于跨作用域排序）"
              },
              "duration": {
                "type": "number",
                "minimum": 0,
                "description": "执行时长（毫秒，可选）"
              },
              "scope_id": {
                "type": "string",
                "description": "所属作用域 ID（引用 VariableScope.id）"
              }
            }
          },
          "description": "执行步骤列表（按 execution_order 全局排序）"
        },
        "variableScopes": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/VariableScope"
          },
          "description": "变量作用域列表"
        },
        "callStack": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/StackFrame"
          },
          "description": "调用栈"
        }
      }
    },
    "VariableScope": {
      "type": "object",
      "required": ["id", "scope_type", "variables", "timestamp", "execution_order"],
      "properties": {
        "id": {
          "type": "string",
          "description": "作用域唯一标识符（UUID v4）"
        },
        "scope_type": {
          "type": "string",
          "enum": ["global", "local", "closure", "class", "module"],
          "description": "作用域类型（global: 全局，local: 局部，closure: 闭包，class: 类，module: 模块）"
        },
        "parent_scope_id": {
          "type": "string",
          "description": "父作用域 ID（支持嵌套作用域，可选）"
        },
        "variables": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/Variable"
          },
          "description": "该作用域内的变量列表"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "进入作用域时刻（ISO 8601 格式）"
        },
        "execution_order": {
          "type": "integer",
          "minimum": 0,
          "description": "执行序号（全局唯一递增，用于跨作用域排序）"
        }
      }
    },
    "Variable": {
      "type": "object",
      "required": ["name", "type", "value"],
      "properties": {
        "name": {
          "type": "string",
          "description": "变量名"
        },
        "type": {
          "type": "string",
          "description": "变量类型（Python: type().__name__，JavaScript: typeof 等）"
        },
        "value": {
          "description": "变量值（序列化为 JSON，任意类型）"
        },
        "memory_address": {
          "type": "string",
          "pattern": "^0x[0-9a-fA-F]+$",
          "description": "内存地址（十六进制字符串，如 \"0x7f8b2c3d1e40\"，可选）"
        },
        "size_bytes": {
          "type": "integer",
          "minimum": 0,
          "description": "内存占用（字节，可选）"
        },
        "is_mutable": {
          "type": "boolean",
          "description": "是否可变（Python: isinstance(x, (list, dict, set))，可选）"
        },
        "references": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "引用的其他对象 ID 列表（用于对象引用图，可选）"
        },
        "history": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/VariableChange"
          },
          "description": "变量变化历史轨迹（可选）"
        }
      }
    },
    "VariableChange": {
      "type": "object",
      "required": ["timestamp", "old_value", "new_value", "execution_order", "changed_at"],
      "properties": {
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "变化时刻（ISO 8601 格式）"
        },
        "old_value": {
          "description": "旧值（任意类型）"
        },
        "new_value": {
          "description": "新值（任意类型）"
        },
        "execution_order": {
          "type": "integer",
          "minimum": 0,
          "description": "变化时的执行序号（全局唯一）"
        },
        "changed_at": {
          "type": "string",
          "pattern": "^.+:\\d+$",
          "description": "修改位置（格式：\"file.py:123\"）"
        }
      }
    },
    "StackFrame": {
      "type": "object",
      "required": ["id", "function_name", "module_name", "file_path", "line_number", "depth", "local_scope_id", "timestamp", "execution_order"],
      "properties": {
        "id": {
          "type": "string",
          "description": "栈帧唯一标识符（UUID v4）"
        },
        "function_name": {
          "type": "string",
          "description": "函数名"
        },
        "module_name": {
          "type": "string",
          "description": "所属模块名"
        },
        "file_path": {
          "type": "string",
          "description": "源代码文件路径"
        },
        "line_number": {
          "type": "integer",
          "minimum": 1,
          "description": "当前执行行号（从1开始）"
        },
        "depth": {
          "type": "integer",
          "minimum": 0,
          "description": "调用深度（0 = 顶层入口）"
        },
        "is_recursive": {
          "type": "boolean",
          "description": "是否递归调用"
        },
        "recursion_depth": {
          "type": "integer",
          "minimum": 0,
          "description": "递归深度（仅当 is_recursive=true 时有效，可选）"
        },
        "arguments": {
          "type": "object",
          "description": "函数参数（名称 -> 值映射）"
        },
        "local_scope_id": {
          "type": "string",
          "description": "关联的局部作用域 ID（引用 VariableScope.id）"
        },
        "parent_frame_id": {
          "type": "string",
          "description": "父栈帧 ID（调用链，可选）"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "进入栈帧的时间戳（ISO 8601 格式）"
        },
        "execution_order": {
          "type": "integer",
          "minimum": 0,
          "description": "执行序号（全局唯一）"
        },
        "return_value": {
          "description": "返回值（函数返回后填充，可选）"
        }
      }
    },
    "ConcurrencyFlow": {
      "type": "object",
      "required": ["id", "type", "involved_units", "start_point", "end_point"],
      "properties": {
        "id": {
          "type": "string"
        },
        "type": {
          "type": "string",
          "enum": ["parallel", "concurrent", "async", "sync_wait"],
          "description": "并发类型"
        },
        "involved_units": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "涉及的代码单元 ID"
        },
        "start_point": {
          "type": "string",
          "description": "起点节点 ID"
        },
        "end_point": {
          "type": "string",
          "description": "终点节点 ID"
        },
        "dependencies": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "依赖的其他并发流 ID（可选）"
        }
      }
    },
    "SyncPoint": {
      "type": "object",
      "required": ["id", "location", "waiting_flows", "type"],
      "properties": {
        "id": {
          "type": "string"
        },
        "location": {
          "type": "string",
          "description": "同步点位置"
        },
        "waiting_flows": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "等待的并发流 ID"
        },
        "type": {
          "type": "string",
          "enum": ["barrier", "mutex", "semaphore", "join"],
          "description": "同步类型"
        }
      }
    }
  }
}
